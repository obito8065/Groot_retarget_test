#!/usr/bin/env python3
"""
Fourier Hand Retarget API - 超轻量级版本
专门用于Policy中的实时retargeting，不包含任何渲染功能
完全避开MANO和数据集加载器依赖

用法示例：
```python
from gr00t.eval.fourier_hand_retarget_api import FourierHandRetargetAPI

# 初始化（只需初始化一次）
retargeter = FourierHandRetargetAPI()

# 在每个episode开始时reset
retargeter.reset()

# 处理每一帧
left_kp = np.array([[wrist_xyz], [thumb_xyz], [index_xyz], [middle_xyz], [ring_xyz], [pinky_xyz]])  # (6, 3)
right_kp = ...  # (6, 3)

result = retargeter.retarget(left_keypoints=left_kp, right_keypoints=right_kp)

# 使用结果
left_wrist_pose = result['left']['wrist_pose']  # (6,): [pos(3), rotvec(3)]
left_finger_joints = result['left']['finger_joints']  # (6,): [pinky, ring, middle, index, thumb_pitch, thumb_yaw]
```
"""

import sys
import numpy as np
from pathlib import Path
from typing import Dict, Optional, List

# 添加retarget路径
retarget_src_path = Path(__file__).parent.parent.parent.parent / "retarget" / "src"
sys.path.insert(0, str(retarget_src_path))

# 只导入核心retargeting组件，避免数据集加载器
from dex_retargeting.constants import HandType, RetargetingType, RobotName, get_default_config_path
from dex_retargeting.retargeting_config import RetargetingConfig
from dex_retargeting.seq_retarget import SeqRetargeting


class FourierHandRetargetAPI:
    """
    Fourier灵巧手Retarget API - 超轻量级版本
    
    直接使用dex_retargeting核心组件，无SAPIEN/MANO依赖
    
    输入：6个关键点 [wrist, thumb_tip, index_tip, middle_tip, ring_tip, pinky_tip]
    输出：wrist 6-dof pose + 6个finger joints
    
    输出顺序说明:
        finger_joints固定按以下顺序输出 (与Target joint order一致):
        [pinky, ring, middle, index, thumb_pitch, thumb_yaw]
        
        对应的关节名称:
        - pinky_proximal_joint
        - ring_proximal_joint
        - middle_proximal_joint
        - index_proximal_joint
        - thumb_proximal_pitch_joint
        - thumb_proximal_yaw_joint
    """
    
    def __init__(
        self, 
        robot_name: str = "fourier",
        hand_sides: List[str] = ["left", "right"],
        wrist_enhance_weight: float = 2.0,
    ):
        """
        初始化Retarget API
        
        Args:
            robot_name: 机器人名称，默认"fourier"
            hand_sides: 手部列表，默认["left", "right"]
            wrist_enhance_weight: 手腕优化权重，默认2.0
        """
        # 转换robot_name为RobotName enum
        if hasattr(RobotName, robot_name):
            self.robot_name_enum = getattr(RobotName, robot_name)
        else:
            raise ValueError(f"Unknown robot: {robot_name}")
        
        self.hand_sides = hand_sides
        self.retargetings = {}
        self.retarget2target = {}  # Pinocchio order -> Target order mapping
        
        # 为每个手侧初始化retargeting
        for side in hand_sides:
            hand_type = getattr(HandType, side)
            
            # 加载配置
            config_path = get_default_config_path(
                self.robot_name_enum, 
                RetargetingType.position, 
                hand_type
            )
            config = RetargetingConfig.load_from_file(config_path)
            
            # 使用config的build方法创建retargeting实例
            retargeting = config.build()
            
            # 设置优化权重
            retargeting.optimizer.set_retarget_weight(wrist_enhance_weight=wrist_enhance_weight)
            
            # 计算从Pinocchio order到Target order的映射
            # retargeting.retarget()返回的是Pinocchio joint order
            # 我们需要转换为target_joint_names的顺序
            retarget2target = np.array([
                retargeting.joint_names.index(joint_name) 
                for joint_name in retargeting.optimizer.target_joint_names
            ], dtype=int)
            
            self.retargetings[side] = retargeting
            self.retarget2target[side] = retarget2target
        
        print(f"[FourierHandRetargetAPI] Initialized successfully")
        print(f"  Robot: {robot_name}, Sides: {hand_sides}")
    
    def retarget(
        self, 
        left_keypoints: Optional[np.ndarray] = None,
        right_keypoints: Optional[np.ndarray] = None,
    ) -> Dict[str, Dict[str, np.ndarray]]:
        """
        执行retargeting
        
        Args:
            left_keypoints: (6, 3) [wrist, thumb, index, middle, ring, pinky] in xyz
            right_keypoints: (6, 3) [wrist, thumb, index, middle, ring, pinky] in xyz
        
        Returns:
            {
                'left': {
                    'wrist_pose': (6,) [pos_xyz(3), rotvec_xyz(3)],
                    'finger_joints': (6,) [pinky, ring, middle, index, thumb_pitch, thumb_yaw]  ← 固定顺序！
                },
                'right': {...}
            }
            
        重要说明:
            finger_joints的输出顺序固定为: [pinky, ring, middle, index, thumb_pitch, thumb_yaw]
            这是Target joint order的顺序，对应于:
                - pinky_proximal_joint
                - ring_proximal_joint
                - middle_proximal_joint
                - index_proximal_joint
                - thumb_proximal_pitch_joint
                - thumb_proximal_yaw_joint
        """
        result = {}
        keypoints_dict = {'left': left_keypoints, 'right': right_keypoints}
        
        for side in self.hand_sides:
            kp = keypoints_dict.get(side)
            if kp is None or kp.shape != (6, 3):
                continue
            
            # 重排序: [wrist, thumb, index, middle, ring, pinky] 
            #      -> [thumb, index, middle, ring, pinky, wrist]
            kp_reordered = kp[[1, 2, 3, 4, 5, 0]]
            
            # 构造21点MANO数组（只填充我们有的6个点）
            hand_21 = np.zeros((21, 3), dtype=np.float32)
            hand_21[[4, 8, 12, 16, 20, 0]] = kp_reordered
            
            # 根据target_link_human_indices提取需要的关键点
            retargeting = self.retargetings[side]
            human_indices = retargeting.optimizer.target_link_human_indices
            human_keypoints = hand_21[human_indices, :]  # (6, 3)
            
            # Retarget: 返回Pinocchio joint order的qpos
            qpos_pinocchio = retargeting.retarget(human_keypoints)
            
            # 转换为Target joint order (与SAPIEN一致的顺序)
            retarget2target = self.retarget2target[side]
            qpos_target = qpos_pinocchio[retarget2target]
            
            # 提取wrist pose (前6维) 和 finger joints
            # Target order: [dummy_xyz(3), dummy_rotvec(3), desired_finger_joints(6), ...]
            # 注意: Target joint order中6-11的顺序就是我们期望的输出顺序
            wrist_pose = qpos_target[0:6]  # [x, y, z, rx, ry, rz]
            finger_joints = qpos_target[6:12]  # ← 固定顺序: [pinky, ring, middle, index, thumb_pitch, thumb_yaw]
            
            result[side] = {
                'wrist_pose': wrist_pose,
                'finger_joints': finger_joints,
            }
        
        return result
    
    def reset(self, env_idx: Optional[int] = None):
        """
        重置历史缓存（新episode开始时调用）
        
        Args:
            env_idx: 并行环境索引，None表示重置所有
        """
        # Position retargeting每次都是独立优化，无需显式reset
        # 但为了API一致性，保留此方法
        for retargeting in self.retargetings.values():
            if hasattr(retargeting, 'optimizer'):
                retargeting.optimizer.reset()


# ============================================================================
# 测试
# ============================================================================
if __name__ == "__main__":
    print("=" * 80)
    print("Testing FourierHandRetargetAPI with Hardcoded Data")
    print("=" * 80)
    
    # 初始化
    print("\n[1] 初始化FourierHandRetargetAPI...")
    api = FourierHandRetargetAPI()
    
    # 使用bash输出中的7帧数据 (bash lines 994-1020)
    # 格式: t L_wrist_xyz L_thumb_xyz L_index_xyz L_middle_xyz L_ring_xyz L_pinky_xyz 
    #          R_wrist_xyz R_thumb_xyz R_index_xyz R_middle_xyz R_ring_xyz R_pinky_xyz
    # 修正后的 test_data（每行都是一个 list，并用逗号分隔）
    test_data = np.array([
        [0, -0.23888783, 0.13361477, 0.21128708, -0.21212703, 0.09537908, 0.07846799, -0.20740351, -0.03168002, 0.19246792, -0.21106663, -0.03976959, 0.21479616, -0.20967075, -0.03099867, 0.23656190, -0.20865492, -0.02023163, 0.25721715, 0.24146207, 0.14099238, 0.21498004, 0.20987324, 0.10381517, 0.08240901, 0.21639382, -0.02478171, 0.19199272, 0.22122593, -0.03338840, 0.21389891, 0.22080760, -0.02536731, 0.23592072, 0.21966217, -0.01528503, 0.25698208],
        [1, -0.24106403, 0.13198325, 0.20984562, -0.17878675, 0.09620664, 0.08528216, -0.21185936, -0.03360254, 0.18993495, -0.21591267, -0.04182995, 0.21214501, -0.21464861, -0.03327071, 0.23400286, -0.21372306, -0.02270071, 0.25476336, 0.24139696, 0.14220571, 0.21413591, 0.17942523, 0.10587179, 0.08932970, 0.21683633, -0.02352265, 0.19029461, 0.22154500, -0.03220873, 0.21219843, 0.22096230, -0.02428119, 0.23424840, 0.21962393, -0.01428715, 0.25534406],
        [2, -0.24376644, 0.13345421, 0.21186467, -0.15425326, 0.09791406, 0.10382787, -0.21800454, -0.03269521, 0.19189697, -0.22267336, -0.04090015, 0.21399443, -0.22163413, -0.03244473, 0.23590415, -0.22086309, -0.02196740, 0.25671803, 0.24211171, 0.14290781, 0.20997320, 0.15316167, 0.10814293, 0.10081107, 0.21760260, -0.02263590, 0.18482788, 0.22208945, -0.03146830, 0.20672057, 0.22130417, -0.02368183, 0.22881351, 0.21976230, -0.01382061, 0.24995894],
        [3, -0.24517113, 0.13427755, 0.21097635, -0.13692721, 0.09671004, 0.12307655, -0.22441942, -0.03256427, 0.19094658, -0.22995003, -0.04068979, 0.21287415, -0.22921922, -0.03235418, 0.23484174, -0.22865602, -0.02198458, 0.25571638, 0.24130424, 0.14328635, 0.20696587, 0.13418861, 0.10991344, 0.11574692, 0.21649936, -0.02207571, 0.18093907, 0.22082991, -0.03101479, 0.20282233, 0.21992786, -0.02332429, 0.22494210, 0.21824843, -0.01355008, 0.24612085],
        [4, -0.24942508, 0.13569270, 0.20933529, -0.13011432, 0.09367872, 0.14179679, -0.23523937, -0.03190271, 0.18987570, -0.24168338, -0.03976042, 0.21165088, -0.24117885, -0.03143617, 0.23362916, -0.24072758, -0.02107409, 0.25451012, 0.24074055, 0.14569372, 0.20284748, 0.12448600, 0.11421835, 0.12463635, 0.21501002, -0.01947435, 0.17648925, 0.21907394, -0.02845573, 0.19840700, 0.21802145, -0.02077123, 0.22052147, 0.21620412, -0.01099582, 0.24168952],
        [5, -0.25808499, 0.13588791, 0.20758468, -0.13320265, 0.08812951, 0.15953603, -0.25166208, -0.03215976, 0.18791171, -0.25920638, -0.03973893, 0.20943060, -0.25901412, -0.03150416, 0.23144753, -0.25873880, -0.02122887, 0.25237399, 0.23922045, 0.14777200, 0.20070182, 0.11778999, 0.11711755, 0.13235081, 0.21298432, -0.01720574, 0.17366485, 0.21672297, -0.02625175, 0.19561550, 0.21542442, -0.01860805, 0.21772959, 0.21335983, -0.00886498, 0.23889291],
        [6, -0.26467711, 0.13724219, 0.20913888, -0.13858993, 0.08252293, 0.17909094, -0.26714737, -0.03087466, 0.18916977, -0.27595083, -0.03803039, 0.21035327, -0.27614636, -0.02984502, 0.23238800, -0.27609212, -0.01962651, 0.25334476, 0.23917468, 0.15019169, 0.19879600, 0.11315167, 0.12134971, 0.14161322, 0.21152572, -0.01438728, 0.17075005, 0.21488710, -0.02356066, 0.19270922, 0.21339183, -0.01599108, 0.21483582, 0.21116140, -0.00630986, 0.23601062],
        [7, -0.26874630, 0.14223792, 0.21616264, -0.14563671, 0.07946914, 0.19821410, -0.28163527, -0.02610229, 0.20338112, -0.29057980, -0.03181618, 0.22494025, -0.28999150, -0.02272177, 0.24660863, -0.28903964, -0.01166016, 0.26711215, 0.23798418, 0.15442051, 0.20207990, 0.10967691, 0.12531918, 0.15403340, 0.20835268, -0.01096918, 0.18196327, 0.21099509, -0.01901755, 0.20445723, 0.20904482, -0.01026952, 0.22610744, 0.20638845, 0.00055221, 0.24667706],
        [8, -0.27169343, 0.14568742, 0.22108096, -0.15230054, 0.07674032, 0.21301885, -0.29392224, -0.02203116, 0.21443852, -0.30285694, -0.02649132, 0.23629600, -0.30146347, -0.01669650, 0.25761897, -0.29960935, -0.00500019, 0.27770509, 0.23708889, 0.15895067, 0.20492346, 0.10711933, 0.13064761, 0.16598912, 0.20557095, -0.00681967, 0.19213669, 0.20755816, -0.01379359, 0.21505316, 0.20521930, -0.00397264, 0.23619844, 0.20223089, 0.00787546, 0.25614666],
        [9, -0.27120006, 0.14820118, 0.22546563, -0.15523222, 0.07524516, 0.22576406, -0.30068550, -0.01852242, 0.22430568, -0.30956048, -0.02191235, 0.24637936, -0.30750863, -0.01153374, 0.26736956, -0.30491882, 0.00068359, 0.28706144, 0.23629241, 0.16262381, 0.20457066, 0.10514324, 0.13626216, 0.17471838, 0.20264134, -0.00307304, 0.19758143, 0.20412865, -0.00918366, 0.22078143, 0.20156283, 0.00147618, 0.24148840, 0.19838870, 0.01412495, 0.26090945],
        [10, -0.26929412, 0.14990709, 0.22739713, -0.15685505, 0.07368761, 0.23492576, -0.30549544, -0.01546346, 0.23046847, -0.31436520, -0.01795424, 0.25266403, -0.31176695, -0.00716206, 0.27338297, -0.30856058, 0.00541249, 0.29275716, 0.23742646, 0.16788679, 0.20222649, 0.10573689, 0.14422611, 0.18031838, 0.20144652, 0.00254517, 0.20010185, 0.20249401, -0.00282483, 0.22350793, 0.19977740, 0.00854198, 0.24381588, 0.19650692, 0.02186193, 0.26276521],
        [11, -0.26819584, 0.15094687, 0.22992681, -0.15874205, 0.07263058, 0.24321160, -0.30961382, -0.01308286, 0.23671946, -0.31841541, -0.01482123, 0.25901381, -0.31534204, -0.00368391, 0.27948334, -0.31161049, 0.00918611, 0.29856756, 0.23644013, 0.17261664, 0.19889981, 0.10477287, 0.15095649, 0.18320773, 0.19898143, 0.00760034, 0.20054285, 0.19969493, 0.00282545, 0.22409188, 0.19679733, 0.01473694, 0.24406293, 0.19341094, 0.02856512, 0.26262163],
        [12, -0.26597643, 0.15135023, 0.22885263, -0.15873464, 0.07208784, 0.24659669, -0.31092585, -0.01161439, 0.23830311, -0.31961741, -0.01283509, 0.26067513, -0.31616087, -0.00147472, 0.28096096, -0.31202534, 0.01158562, 0.29983069, 0.23739350, 0.17590086, 0.19218700, 0.10604193, 0.15650713, 0.18151074, 0.19835224, 0.01131569, 0.19706479, 0.19868760, 0.00707708, 0.22072466, 0.19561950, 0.01947114, 0.24037431, 0.19210247, 0.03375318, 0.25856137],
        [13, -0.26043323, 0.15192062, 0.22541107, -0.15523983, 0.07186023, 0.24691120, -0.30859096, -0.01000587, 0.23671376, -0.31724180, -0.01081597, 0.25911967, -0.31349622, 0.00068530, 0.27927616, -0.30905210, 0.01386131, 0.29799453, 0.23809280, 0.17830749, 0.18829793, 0.10710962, 0.16024515, 0.18083942, 0.19826169, 0.01400951, 0.19576532, 0.19835206, 0.01019873, 0.21950078, 0.19515038, 0.02295893, 0.23889235, 0.19151308, 0.03758393, 0.25678203],
        [14, -0.25735184, 0.15313640, 0.22429597, -0.15364639, 0.07277326, 0.24886217, -0.30767636, -0.00795031, 0.23791932, -0.31624286, -0.00834800, 0.26036881, -0.31225564, 0.00336341, 0.28035694, -0.30755039, 0.01671996, 0.29888282, 0.23536319, 0.18301801, 0.18269354, 0.10447845, 0.16582129, 0.17516808, 0.19489082, 0.01895673, 0.19169805, 0.19470953, 0.01542771, 0.21546706, 0.19134395, 0.02842985, 0.23467884, 0.18764275, 0.04326768, 0.25237402],
        [15, -0.25253048, 0.15563682, 0.22423610, -0.15027028, 0.07499261, 0.25158806, -0.30499038, -0.00460942, 0.23960289, -0.31353642, -0.00465670, 0.26206309, -0.30937521, 0.00721133, 0.28192272, -0.30447388, 0.02069862, 0.30030255, 0.23297255, 0.19001705, 0.17791104, 0.10208950, 0.17264558, 0.16900220, 0.19217730, 0.02613387, 0.18855292, 0.19177287, 0.02289751, 0.21236157, 0.18825085, 0.03613868, 0.23138005, 0.18439980, 0.05119903, 0.24885493],
        [16, -0.24918104, 0.15690222, 0.22184746, -0.14814189, 0.07616611, 0.25173900, -0.30320475, -0.00269620, 0.23848566, -0.31177804, -0.00247298, 0.26093445, -0.30752787, 0.00952072, 0.28069918, -0.30251816, 0.02311323, 0.29897204, 0.23053444, 0.19573157, 0.17443765, 0.09971308, 0.17803721, 0.16477348, 0.18983881, 0.03190256, 0.18622548, 0.18929477, 0.02886922, 0.21005927, 0.18564527, 0.04226702, 0.22894187, 0.18165790, 0.05747321, 0.24626093],
        [17, -0.24486494, 0.15879031, 0.21894047, -0.14498675, 0.07787066, 0.25092717, -0.30043806, -0.00020384, 0.23624674, -0.30907741, 0.00021795, 0.25866699, -0.30477809, 0.01227631, 0.27838148, -0.29969816, 0.02591780, 0.29659843, 0.23105820, 0.20043391, 0.16973160, 0.10029705, 0.18276264, 0.15938972, 0.19027736, 0.03664798, 0.18183066, 0.18960122, 0.03369221, 0.20567112, 0.18585352, 0.04715183, 0.22448962, 0.18177372, 0.06241509, 0.24173630],
        [18, -0.24177781, 0.16269652, 0.21715625, -0.14271798, 0.08175122, 0.25069483, -0.29851154, 0.00425463, 0.23571632, -0.30712589, 0.00491016, 0.25814068, -0.30271785, 0.01708490, 0.27775935, -0.29751831, 0.03082535, 0.29586797, 0.23200515, 0.20323213, 0.16711652, 0.10122756, 0.18556192, 0.15679253, 0.19103955, 0.03960678, 0.18066937, 0.19034572, 0.03686845, 0.20453613, 0.18660631, 0.05050000, 0.22322988, 0.18251799, 0.06592444, 0.24033223],
        [19, -0.23739054, 0.16173469, 0.21291979, -0.13939836, 0.08061950, 0.24837070, -0.29548525, 0.00390149, 0.23242806, -0.30416728, 0.00479007, 0.25481875, -0.29972266, 0.01706845, 0.27436382, -0.29446430, 0.03089337, 0.29239138, 0.23749725, 0.20635337, 0.16725676, 0.10648229, 0.18974024, 0.15844649, 0.19530188, 0.04321939, 0.18283738, 0.19483159, 0.04071687, 0.20673473, 0.19141106, 0.05456094, 0.22533319, 0.18765588, 0.07018167, 0.24232908],
        [20, -0.23181778, 0.16464272, 0.21218488, -0.13433251, 0.08331905, 0.24834916, -0.29091917, 0.00731538, 0.23273096, -0.29960595, 0.00840978, 0.25511039, -0.29510442, 0.02079672, 0.27457185, -0.28976059, 0.03470777, 0.29250982, 0.23658505, 0.20785037, 0.16686814, 0.10555272, 0.19160123, 0.15770754, 0.19381179, 0.04500060, 0.18375104, 0.19323942, 0.04271974, 0.20766889, 0.18971747, 0.05675349, 0.22611614, 0.18594063, 0.07253916, 0.24295320],
        [21, -0.22742622, 0.16693110, 0.21138430, -0.13064563, 0.08497288, 0.24800057, -0.28782138, 0.01022380, 0.23288388, -0.29647412, 0.01151785, 0.25526600, -0.29184672, 0.02397608, 0.27465224, -0.28636555, 0.03794250, 0.29250559, 0.23652383, 0.21084724, 0.16684528, 0.10547620, 0.19488340, 0.15768110, 0.19338639, 0.04826398, 0.18530460, 0.19278369, 0.04622179, 0.20924283, 0.18927922, 0.06044546, 0.22754703, 0.18552828, 0.07640456, 0.24422409],
        [22, -0.22844636, 0.16875690, 0.21172840, -0.13256174, 0.08625034, 0.24953193, -0.29019835, 0.01269896, 0.23408328, -0.29897078, 0.01423417, 0.25640327, -0.29435909, 0.02680697, 0.27571942, -0.28887725, 0.04087083, 0.29349510, 0.23712898, 0.21247992, 0.16594002, 0.10602391, 0.19652992, 0.15747883, 0.19386876, 0.05016605, 0.18637620, 0.19336199, 0.04839068, 0.21033879, 0.18995823, 0.06281873, 0.22849880, 0.18628242, 0.07896797, 0.24501028],
        [23, -0.22531056, 0.16845656, 0.21348032, -0.12991650, 0.08579912, 0.25212941, -0.28771929, 0.01267589, 0.23594273, -0.29661850, 0.01430915, 0.25820559, -0.29207636, 0.02692410, 0.27751107, -0.28665239, 0.04102352, 0.29527616, 0.23597680, 0.21580785, 0.16694863, 0.10495304, 0.20015695, 0.15720721, 0.19234969, 0.05352997, 0.18688442, 0.19160227, 0.05174347, 0.21083768, 0.18805125, 0.06616420, 0.22897464, 0.18423828, 0.08230910, 0.24546026],
        [24, -0.22297662, 0.16906511, 0.21408968, -0.12793667, 0.08646666, 0.25370522, -0.28600622, 0.01376617, 0.23810122, -0.29492005, 0.01566367, 0.26033701, -0.29034809, 0.02846057, 0.27951553, -0.28488980, 0.04272356, 0.29713859, 0.23591513, 0.21932126, 0.16738336, 0.10493382, 0.20340999, 0.15730527, 0.19237909, 0.05709692, 0.18794724, 0.19154844, 0.05542451, 0.21190565, 0.18793308, 0.06992637, 0.22996301, 0.18404718, 0.08614621, 0.24635793],
        [25, -0.21993925, 0.17235574, 0.21170588, -0.12564300, 0.08937482, 0.25222283, -0.28421998, 0.01767157, 0.23636128, -0.29321727, 0.01976751, 0.25854550, -0.28863009, 0.03264302, 0.27766900, -0.28315033, 0.04697340, 0.29522930, 0.23723475, 0.22305422, 0.16751320, 0.10624089, 0.20698214, 0.15778506, 0.19391645, 0.06078927, 0.18821647, 0.19315716, 0.05911874, 0.21217831, 0.18958141, 0.07361813, 0.23024413, 0.18572066, 0.08983608, 0.24664683],
        [26, -0.21994827, 0.17665145, 0.21514625, -0.12610104, 0.09340979, 0.25632635, -0.28488945, 0.02235080, 0.24046494, -0.29395643, 0.02460811, 0.26260510, -0.28938614, 0.03757561, 0.28167060, -0.28391342, 0.05198613, 0.29916740, 0.23779044, 0.22615188, 0.16749669, 0.10678770, 0.21005162, 0.15787095, 0.19447594, 0.06393849, 0.18859969, 0.19373566, 0.06232386, 0.21256694, 0.19018374, 0.07686152, 0.23060334, 0.18630959, 0.09312083, 0.24696669],
        [27, -0.21898860, 0.17958835, 0.21843324, -0.12558707, 0.09635675, 0.26056068, -0.28451302, 0.02566283, 0.24451958, -0.29364040, 0.02808906, 0.26661697, -0.28908989, 0.04116263, 0.28561378, -0.28362009, 0.05566331, 0.30303768, 0.23649399, 0.22883948, 0.16751822, 0.10556518, 0.21266946, 0.15706828, 0.19304235, 0.06678024, 0.18950101, 0.19215781, 0.06533789, 0.21347794, 0.18847738, 0.08000513, 0.23138217, 0.18445402, 0.09638921, 0.24759215],
        [28, -0.22138069, 0.17945097, 0.22117485, -0.12888309, 0.09586523, 0.26458952, -0.28816864, 0.02620530, 0.24804836, -0.29741723, 0.02886999, 0.27006764, -0.29289315, 0.04206026, 0.28899005, -0.28743191, 0.05665947, 0.30633372, 0.23739519, 0.23345588, 0.16700938, 0.10649229, 0.21711490, 0.15675461, 0.19420546, 0.07146686, 0.19001252, 0.19334076, 0.07016739, 0.21399758, 0.18965478, 0.08493847, 0.23181612, 0.18564115, 0.10141159, 0.24793397],
        [29, -0.21912429, 0.18288990, 0.22359562, -0.12706893, 0.09925673, 0.26776496, -0.28669249, 0.03009832, 0.25109686, -0.29600549, 0.03292826, 0.27306804, -0.29149138, 0.04620626, 0.29193101, -0.28602081, 0.06087714, 0.30921261, 0.23521913, 0.23517851, 0.16722541, 0.10441876, 0.21869701, 0.15565649, 0.19183958, 0.07321467, 0.19002811, 0.19073366, 0.07195349, 0.21400629, 0.18685826, 0.08674858, 0.23176318, 0.18265196, 0.10324660, 0.24780991],
    ], dtype=np.float32)
    
    print(f"\n[2] 加载了 {len(test_data)} 帧测试数据")
    
    # 测试前5帧（详细输出）
    print("\n" + "=" * 80)
    print("前5帧详细输出")
    print("=" * 80)
    
    all_left_wrist_poses = []
    all_left_finger_joints = []
    all_right_wrist_poses = []
    all_right_finger_joints = []
    
    for i in range(len(test_data)):
        frame_idx = int(test_data[i, 0])
        
        # 提取左手6个关键点
        left_kp = np.zeros((6, 3), dtype=np.float32)
        left_kp[0] = test_data[i, 1:4]    # wrist
        left_kp[1] = test_data[i, 4:7]    # thumb
        left_kp[2] = test_data[i, 7:10]   # index
        left_kp[3] = test_data[i, 10:13]  # middle
        left_kp[4] = test_data[i, 13:16]  # ring
        left_kp[5] = test_data[i, 16:19]  # pinky
        
        # 提取右手6个关键点
        right_kp = np.zeros((6, 3), dtype=np.float32)
        right_kp[0] = test_data[i, 19:22]  # wrist
        right_kp[1] = test_data[i, 22:25]  # thumb
        right_kp[2] = test_data[i, 25:28]  # index
        right_kp[3] = test_data[i, 28:31]  # middle
        right_kp[4] = test_data[i, 31:34]  # ring
        right_kp[5] = test_data[i, 34:37]  # pinky
        
        # 只打印前5帧的详细信息
        if i < 30:
            print(f"\n{'='*80}")
            print(f"Frame {frame_idx}")
            print(f"{'='*80}")
            
            print("\n[输入] 6个关键点 (相机坐标系)")
            print("\n左手关键点:")
            keypoint_names = ["Wrist", "Thumb", "Index", "Middle", "Ring", "Pinky"]
            for j, name in enumerate(keypoint_names):
                print(f"  {name:8s}: [{left_kp[j,0]:9.6f}, {left_kp[j,1]:9.6f}, {left_kp[j,2]:9.6f}]")
            
            print("\n右手关键点:")
            for j, name in enumerate(keypoint_names):
                print(f"  {name:8s}: [{right_kp[j,0]:9.6f}, {right_kp[j,1]:9.6f}, {right_kp[j,2]:9.6f}]")
        
        # Retarget
        result = api.retarget(left_kp, right_kp)
        
        # 只打印前5帧的详细输出
        if i < 30:
            print("\n[输出] Fourier灵巧手控制量")
            
            for side in ['left', 'right']:
                if side in result:
                    side_result = result[side]
                    print(f"\n{side.capitalize()}手控制量:")
                    print(f"  Wrist Pose (6-DOF):")
                    print(f"    位置 [x, y, z]:        [{side_result['wrist_pose'][0]:9.6f}, "
                          f"{side_result['wrist_pose'][1]:9.6f}, {side_result['wrist_pose'][2]:9.6f}]")
                    print(f"    旋转向量 [rx, ry, rz]: [{side_result['wrist_pose'][3]:9.6f}, "
                          f"{side_result['wrist_pose'][4]:9.6f}, {side_result['wrist_pose'][5]:9.6f}]")
                    print(f"  Finger Joints (6个关节角度 rad):")
                    finger_names = ["Pinky", "Ring", "Middle", "Index", "Thumb_Pitch", "Thumb_Yaw"]
                    for j, fname in enumerate(finger_names):
                        print(f"    {fname:12s}: {side_result['finger_joints'][j]:9.6f}")
        
        # 收集所有帧数据用于统计
        if 'left' in result:
            all_left_wrist_poses.append(result['left']['wrist_pose'])
            all_left_finger_joints.append(result['left']['finger_joints'])
        
        if 'right' in result:
            all_right_wrist_poses.append(result['right']['wrist_pose'])
            all_right_finger_joints.append(result['right']['finger_joints'])
    
    # 统计所有7帧
    print("\n" + "=" * 80)
    print("所有7帧统计结果")
    print("=" * 80)
    
    all_left_wrist_poses = np.array(all_left_wrist_poses)
    all_left_finger_joints = np.array(all_left_finger_joints)
    all_right_wrist_poses = np.array(all_right_wrist_poses)
    all_right_finger_joints = np.array(all_right_finger_joints)
    
    print(f"\n左手Wrist位置 (前3维):")
    print(f"  平均: [{all_left_wrist_poses[:,0].mean():9.6f}, "
          f"{all_left_wrist_poses[:,1].mean():9.6f}, {all_left_wrist_poses[:,2].mean():9.6f}]")
    print(f"  范围: X=[{all_left_wrist_poses[:,0].min():9.6f}, {all_left_wrist_poses[:,0].max():9.6f}]")
    print(f"       Y=[{all_left_wrist_poses[:,1].min():9.6f}, {all_left_wrist_poses[:,1].max():9.6f}]")
    print(f"       Z=[{all_left_wrist_poses[:,2].min():9.6f}, {all_left_wrist_poses[:,2].max():9.6f}]")
    
    print(f"\n右手Wrist位置 (前3维):")
    print(f"  平均: [{all_right_wrist_poses[:,0].mean():9.6f}, "
          f"{all_right_wrist_poses[:,1].mean():9.6f}, {all_right_wrist_poses[:,2].mean():9.6f}]")
    print(f"  范围: X=[{all_right_wrist_poses[:,0].min():9.6f}, {all_right_wrist_poses[:,0].max():9.6f}]")
    print(f"       Y=[{all_right_wrist_poses[:,1].min():9.6f}, {all_right_wrist_poses[:,1].max():9.6f}]")
    print(f"       Z=[{all_right_wrist_poses[:,2].min():9.6f}, {all_right_wrist_poses[:,2].max():9.6f}]")
    
    print(f"\n左手Finger Joints统计:")
    finger_names = ["Pinky", "Ring", "Middle", "Index", "Thumb_Pitch", "Thumb_Yaw"]
    for j, name in enumerate(finger_names):
        print(f"  {name:12s}: 平均={all_left_finger_joints[:,j].mean():9.6f}, "
              f"范围=[{all_left_finger_joints[:,j].min():9.6f}, {all_left_finger_joints[:,j].max():9.6f}]")
    
    print(f"\n右手Finger Joints统计:")
    for j, name in enumerate(finger_names):
        print(f"  {name:12s}: 平均={all_right_finger_joints[:,j].mean():9.6f}, "
              f"范围=[{all_right_finger_joints[:,j].min():9.6f}, {all_right_finger_joints[:,j].max():9.6f}]")
    
    print("\n" + "=" * 80)
    print("✅ Test completed!")
    print("=" * 80)
